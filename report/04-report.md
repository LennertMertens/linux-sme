# Enterprise Linux Lab Report: 04-integration

- Student name: Lennert Mertens
- Github repo: <https://github.com/HoGentTIN/elnx-1819-sme-LennertMertens>

Configuring a DHCP server to hand out IP addresses dynamically in the network, also based on pc's MAC addresses. In order to get a fully functioning network we need to configure the router. The router is configured with VyOS (based on Cisco IOS).

# Part1:  DHCP 

## Test plan
### Prerequisites 

- [ ] Create a new Fedora client in VirtualBox: `linuxclient`
- [ ] Add two `Host-Only adapters` of type `vboxnet1` (same network as the pr001 and pr011 server)
- [ ] Check the MAC address of the first adapter and use it to configure the DHCP server

### 1. Interface 1: receive IP based on MAC address

- [ ] Log in to the VM
- [ ] Check the interface names and write down
- [ ] Make sure IP addresses are received through DHCP (Standard on Fedora)
    - Interface configurations should look like this: (`/etc/sysconfig/network-scripts/ifcfg-enp0s3`)
    ```bash
    # Example for DHCP
    BOOTPROTO=dhcp  # Should be DHCP  
    DEVICE=enp0s3   # Should be the interface name
    ONBOOT=yes      # should be yes, or the interface will not attempt to activate the interface on boot, or when restarting the network interfaces (systemctl restart network)
    ```
    - Restart the network after modifications: `sudo systemctl restart NetworkManager`
- [ ] Check the received IP address; should be: `172.16.128.7`
- [ ] Client received the proper DNS server through DHCP: `cat /etc/resolv.conf`
    - Should be: 
      ```
      # Generated by NetworkManager
      search avalon.lan
      nameserver 172.16.255.254
      ```
- [ ] Client's default gateway is `172.16.255.254`: `ip r`
- [ ] Client can ping to servers in same network (based on IP)


### 2. Interface 2: receive IP through DHCP (Dynamically assigned)

- [ ] Check the received IP address; should be in the range of `172.16.192.1 - 172.16.255.253`
- [ ] Client received the proper DNS server through DHCP: `cat /etc/resolv.conf`
    - Should be: 
      ```
      # Generated by NetworkManager
      search avalon.lan
      nameserver 172.16.255.254
      ```
- [ ] Client's default gateway is `172.16.255.254`: `ip r`
- [ ] Client can ping to servers in same network (based on IP)


## Procedure/Documentation
#### vagrant-hosts.yml
[vagrant-hosts.yml](../vagrant-hosts.yml)

- Add  `pr001` with the correct ip (`172.16.0.2`)
- Add the option `netmask` with a value of `255.255.0.0` to the vagrant-hosts too

#### site.yml
[Link to file](../ansible/site.yml)

- Add entry for `pr001` with the roles:
  - bertvv.dhcp

#### pr001.yml
[pr001.yml](../ansible/host_vars/pr001.yml)

- Allow DHCP services through firewall
```yml
rhbase_firewall_allow_services:
  - dhcp
```

- Add the default gateway, domain name and subnet mask of the network
```yml
dhcp_global_routers: 172.16.255.254 
dhcp_global_domain_name: avalon.lan
dhcp_global_subnet_mask: 255.255.0.0
```

- Add the name servers `pu001`, `pu002`, and back-up `10.0.2.3`
```yml
dhcp_global_domain_name_servers:
  - 172.16.255.254
```

- Configure a lease-time of 24 hours
```yml
dhcp_global_default_lease_time: 86400
```

- Add the subnets for which DHCP should hand out addresses and configure the range
  - SN1: range `172.16.128.1 - 172.16.191.254`
  - SN2: range `172.16.192.1 - 172.16.255.253`
```yml
dhcp_subnets:
  - ip: 172.16.0.0
    netmask: 255.255.0.0
    range_begin: 172.16.128.1
    range_end: 172.16.191.254
  - ip: 172.16.0.0
    netmask: 255.255.0.0
    range_begin: 172.16.192.1
    range_end: 172.16.255.253
```

- Add a host which should receive an IP address based on it's MAC address
- Retrieve the MAC address from VirtualBox, open the setting of the earlier created VM (according to the test plan)
- The MAC address is located under `Network > Adapter 1 > Advanced > MAC Address`
- MAC Address of my test VM: `08:00:27:f7:8d:61`
```yml
dhcp_hosts:
  - name: linuxclient
    mac: '08:00:27:f7:8d:61'
    ip: 172.16.128.7
```

## Test report

### Prerequisites 

- [x] Create a new Fedora client in VirtualBox: `linuxclient`
- [x] Add two `Host-Only adapters` of type `vboxnet1` (same network as the pr001 and pr011 server)
- [x] Check the MAC address of the first adapter and use it to configure the DHCP server
    - MAC Address: '08:00:27:f7:8d:61'

### 1. Interface 1: receive IP based on MAC address

- [x] Log in to the VM
- [x] Check the interface names and write down
  - Interface 1: `enp0s3`
  - Interface 2: `enp0s8`
- [x] Make sure IP addresses are received through DHCP (Standard on Fedora)
    - Interface configurations should look like this: (`/etc/sysconfig/network-scripts/ifcfg-enp0s3`)
    ```bash
    # Example for DHCP
    BOOTPROTO=dhcp  # Should be DHCP  
    DEVICE=enp0s3   # Should be the interface name
    ONBOOT=yes      # should be yes, or the interface will not attempt to activate the interface on boot, or when restarting the network interfaces (systemctl restart network)
    ```
    - Restart the network after modifications: `sudo systemctl restart NetworkManager`
- [x] Check the received IP address; should be: `172.16.128.7`
- [x] Client received the proper DNS server through DHCP: `cat /etc/resolv.conf`
    - Should be: 
      ```
      # Generated by NetworkManager
      search avalon.lan
      nameserver 172.16.255.254
      ```
- [x] Client's default gateway is `172.16.255.254`: `ip r`
- [x] Client can ping to servers in same network (based on IP)


### 2. Interface 2: receive IP through DHCP (Dynamically assigned)

- [x] Check the received IP address; should be in the range of `172.16.192.1 - 172.16.255.253`
- [x] Client received the proper DNS server through DHCP: `cat /etc/resolv.conf`
    - Should be: 
      ```
      # Generated by NetworkManager
      search avalon.lan
      nameserver 172.16.255.254
      ```
- [x] Client's default gateway is `172.16.255.254`: `ip r`
- [x] Client can ping to servers in same network (based on IP)


# Part 2: Router VyOS

## Test plan

- [ ] `/etc/resolv.conf` looks as following on `pu001`, `pu002` and `pu004`
```
# Ansible managed
domain avalon.lan
nameserver 192.0.2.254
search avalon.lan 
```
- [ ] `/etc/resolv.conf` looks as following on `pr001` and `pr011`
```
# Ansible managed
domain avalon.lan
nameserver 172.16.255.254
search avalon.lan 
```
- [ ] Pinging from `pu004` to `files` works
- [ ] Pinging from `pr001` to `ns2` works
- [ ] Pinging from `pu002` to `wwww.google.com` works
- [ ] Pinging form `pr011` to `www.hogent.be` works

### Test from earlier created Fedora client
- [ ] Pinging to all servers in the network works
- [ ] Test page is visible when browsing to `https://www.avalon.lan`
- [ ] Surf to `ftp://files.avalon.lan` 
  - [ ] Log in with user: `nehirb`(same password)
  - [ ] Loging into file server succeeded 
  - [ ] User has only acces to the `it` and `public` share
- [ ] Execute following from the Terminal: `smbclient //files/it -U lennertm` (password: `lennertm`)
  - [ ] Loging in to the file server via smb works


## Procedure/Documentation
#### Basic Router settings
Setting the `avalon.lan` domain name
```
set system domain-name 'avalon.lan'
```

#### Configure the right IP settings
```bash
# Configure the NAT adapter (eth0)
set interfaces ethernet eth0 description 'WAN link'
set interfaces ethernet eth0 address dhcp
# Configure the DMZ adapter (eth1)
set interfaces ethernet eth1 description 'DMZ'
set interfaces ethernet eth1 address '192.0.2.254/24'
# Configure the internal network adapter (eth2)
set interfaces ethernet eth2 description 'internal'
set interfaces ethernet eth2 address '172.16.255.254/16'
```

#### Configure the NTP server
- Delete the current NTP
- Add `be.pool.ntp.org` as NTP server
- Change the Timezone to `Belgium/Brussels`
```bash
delete system ntp
set system ntp server be.pool.ntp.org
set system time-zone 'Europe/Brussels'
```

#### Configure DNS settings
```bash
# Setting DNS forwarder for specific domain: avalon.lan
set service dns forwarding domain avalon.lan server 192.0.2.10
# Setting DNS forwarder to the internet and make use of VirtualBox's built-in DNS server
set service dns forwarding name-server 10.0.2.3
set service dns forwarding listen-on 'eth1'
set service dns forwarding listen-on 'eth2'
```

#### Configuring NAT
- Configure the `eth0` and `eth1` interface as outgoing interfaces for the `172.16.0.0/16` network.
```bash
set nat source rule 100 outbound-interface 'eth0'
set nat source rule 100 source address '172.16.0.0/16'
set nat source rule 100 translation address masquerade
set nat source rule 200 outbound-interface 'eth0'
set nat source rule 200 source address '192.0.2.0/24'
set nat source rule 200 translation address masquerade
```

### Adding nameservers to all servers

After checking the DNS settings on all servers it became clear that NetworkManager was setting up `/etc/resolv.conf` with the wrong nameservers (default `10.0.2.3`). I wrote an Ansible role to configure the required nameservers in the proper way, through the network interface configuration files.
[Ansible role lennertmertens.dns](https://github.com/LennertMertens/ansible-role-dns)
All I have to configure is the search domain and the IP address of the nameservers:

- For `pu001`, `pu002` and `pu004`
```yml
dns_search: avalon.lan
dns_nameservers: 
  - 'DNS1=192.0.2.254'
```
- For `pr001` and `pr011`
```yml
dns_search: avalon.lan
dns_nameservers: 
  - 'DNS1=172.16.255.254'
```


### Configure the default gateway on all servers
In order to complete and configure a fully functioning network which forwards it's request through the router it's necessary to add the proper default gateway.

These settings are configured through `nmcli` and are added to ansible tasks for automation.
Default gateways for both networks:
  - 192.0.2.0/24: `192.0.2.254`
  - 172.16.0.0/16: `172.16.255.254`

```yml
# Configure eth0
- name: Configure default gateway on eth0
    shell: nmcli con modify eth0 ipv4.never-default true
# Configure eth1
- name: Configure default gateway on eth1
    shell: nmcli con modify System\ eth1 ipv4.never-default false
# Add the default gateway
- name: Add default gateway
      shell: nmcli con modify System\ eth1 ipv4.gateway 172.16.255.254
```

**Note:** It's impoortant to provision the router before the other servers because packages will be downloaded through the router.


## Test report

- [x] `/etc/resolv.conf` looks as following on `pu001`, `pu002` and `pu004`
```
# Ansible managed
domain avalon.lan
nameserver 192.0.2.254
search avalon.lan 
```
- [x] `/etc/resolv.conf` looks as following on `pr001` and `pr011`
```
# Ansible managed
domain avalon.lan
nameserver 172.16.255.254
search avalon.lan 
```
- [x] Pinging from `pu004` to `files` works
- [x] Pinging from `pr001` to `ns2` works
- [x] Pinging from `pu002` to `wwww.google.com` works
- [x] Pinging form `pr011` to `www.hogent.be` works

### Test from earlier created Fedora client
- [x] Pinging to all servers in the network works
- [x] Test page is visible when browsing to `https://www.avalon.lan`
- [x] Surf to `ftp://files.avalon.lan` 
  - [x] Log in with user: `nehirb`(same password)
  - [x] Loging into file server succeeded 
  - [x] User has only acces to the `it, technical` and `public` share
- [x] Execute following from the Terminal: `smbclient //files/it -U lennertm` (password: `lennertm`)
  - [x] Loging in to the file server via smb works


## Issues
- [FIXED] After `sudo systemctl restart network` the `/etc/resolv.conf` gets erased and built again by VirtualBox's Network Manager. This provides the incorrect nameservers and is a big issue, according to me. 


## Resources

- [bertvv.dhcp](https://github.com/bertvv/ansible-role-dhcp)
- [How to configure DHCP server on CentOS/RHEL7/6/5 ](https://tecadmin.net/configuring-dhcp-server-on-centos-redhat/)
- [CentOS 7: Setup a DHCP server and provide specific IP based on MAC address](https://bytefreaks.net/gnulinux/centos-7-setup-a-dhcp-server-and-provide-specific-ip-based-on-mac-address)
- [bertvv Cheat-sheet VyOS](https://github.com/bertvv/cheat-sheets/blob/master/docs/VyOS.md)
- [Masquerading IP](http://www.simonzone.com/software/guidedog/manual/whatisnat.html)